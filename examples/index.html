<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
</head>
<body>
  <script src="/dist/d3-trace.js"></script>
  <script src="./trace.js"></script>
  <script>
  const { spans } = traceData.result

  let number = 0

  function transformData (spansData) {
    // eslint-disable-next-line no-shadow
    let spans = spansData

    const count = Math.floor(Math.random() * 10)

    for (let i = 0; i < count; i += 1) {
      spans = spans.concat(spansData)
    }

    if (number % 3 === 0) {
      spans = spansData
    }

    spans = JSON.parse(JSON.stringify(spans))
    number += 1

    if (!spans.length) return []


    let rootNode = null
    let minStartTime = spans[0].startTime

    for (let i = 0; i < spans.length; i += 1) {
      const span = spans[i]
      span.children = []

      minStartTime = Math.min(span.startTime, minStartTime)

      // 父节点
      if (!rootNode && span.traceID === span.spanID) {
        rootNode = span
      }

      for (let j = 0; j < span.references.length; j += 1) {
        const { spanID } = span.references[j]
        const targetSpan = spans.find((item) => item.spanID === spanID)
        if (!targetSpan) {
          break
        }
        targetSpan.children.push(span)
      }
    }

    for (let i = 0; i < spans.length; i += 1) {
      const span = spans[i]
      span.startTime -= minStartTime
      span.startTime /= 1000
      span.endTime = span.startTime + span.duration
    }
    return [rootNode]
  }
  </script>
  <script>
    const instance = new window['d3-trace'](document.body, {
      brushEnd () {},
      data: transformData(spans),
    })
    instance.render()

    const button = document.createElement('button')
    button.innerHTML = 'Data driven'
    document.body.appendChild(button)

    button.addEventListener('click', () => {
      instance.setOptions(transformData(spans))
    }, false)
  </script>
</body>
</html>
